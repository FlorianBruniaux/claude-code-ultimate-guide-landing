---
import Layout from '../../layouts/Layout.astro'

const title = 'Claude Code Quiz: 274 Questions | Test Free'
const description = 'Free Claude Code quiz with 274 questions across 15 categories. Test your knowledge from beginner to power user. Track progress and share your score.'

const jsonLd = [
  {
    "@type": "Quiz",
    "name": "Claude Code Knowledge Quiz",
    "description": "274 questions to test your Claude Code expertise across 15 categories",
    "url": "https://cc.bruniaux.com/quiz/",
    "author": {"@type": "Person", "name": "Florian BRUNIAUX"},
    "publisher": {"@type": "Organization", "name": "Claude Code Ultimate Guide"},
    "datePublished": "2026-01-17",
    "educationalLevel": "beginner to advanced",
    "numberOfQuestions": 274,
    "inLanguage": "en",
    "audience": {
      "@type": "Audience",
      "audienceType": "Software developers learning Claude Code"
    }
  }
]
---

<Layout title={title} description={description} jsonLd={jsonLd}>
  <div class="quiz-container">
    <!-- Setup Screen -->
    <div id="quiz-setup" class="quiz-setup">
      <img src="/claude-code-logo.webp" alt="Claude Code AI coding assistant quiz logo" style="width: 80px; margin-bottom: var(--space-lg);">
      <h1>Claude Code Knowledge Quiz</h1>
      <p>274 questions across 15 categories. Test your knowledge and share your score.</p>

      <div class="category-header">
        <h3>Select Categories</h3>
        <div class="category-actions">
          <button class="category-action-btn" id="select-all-btn">Select All</button>
          <button class="category-action-btn" id="deselect-all-btn">Deselect All</button>
        </div>
      </div>
      <div class="category-grid" id="category-grid">
        <!-- Populated by JS -->
      </div>

      <div class="selected-count" id="selected-count">0 questions selected</div>
      <div class="previous-best" id="previous-best"></div>

      <h3 style="margin-bottom: var(--space-md);">Filter by Difficulty (optional)</h3>
      <div class="difficulty-select">
        <button class="difficulty-btn selected" data-difficulty="all">All Levels</button>
        <button class="difficulty-btn" data-difficulty="junior">Junior</button>
        <button class="difficulty-btn" data-difficulty="senior">Senior</button>
        <button class="difficulty-btn" data-difficulty="power">Power User</button>
      </div>

      <button class="btn btn-primary start-btn" id="start-btn" disabled>Start Quiz</button>
    </div>

    <!-- Question Screen -->
    <div id="quiz-question" class="quiz-question">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>

      <div class="question-header">
        <span class="question-number" id="question-number">1 / 10</span>
        <span class="question-category" id="question-category">Category</span>
        <span class="question-difficulty" id="question-difficulty">junior</span>
      </div>

      <p class="question-text" id="question-text">Question text here?</p>

      <div class="options-list" id="options-list">
        <!-- Populated by JS -->
      </div>

      <div class="explanation-box" id="explanation-box">
        <h4>Explanation</h4>
        <p id="explanation-text"></p>
        <div class="success-rate" id="success-rate"></div>
        <div class="doc-links">
          <a id="doc-link" class="doc-link" href="#" target="_blank" rel="noopener">View in documentation &rarr;</a>
          <a id="official-doc-link" class="doc-link official-doc-link" href="#" target="_blank" rel="noopener">Official docs &rarr;</a>
        </div>
        <div class="report-error-section">
          <a href="#" class="btn-report-error" id="btn-report-error" target="_blank" rel="noopener noreferrer">Report error on GitHub</a>
        </div>
      </div>

      <div class="question-actions">
        <button class="btn btn-secondary nav-btn" id="prev-btn" disabled>Previous</button>
        <button class="btn btn-primary nav-btn" id="next-btn">Next</button>
      </div>
    </div>

    <!-- Results Screen -->
    <div id="quiz-results" class="quiz-results">
      <div class="results-card" id="results-card">
        <div class="screenshot-badge">
          <img src="/claude-code-logo.webp" alt="Claude Code AI assistant certification badge">
          <div class="screenshot-badge-text">
            <div class="screenshot-badge-title">Claude Code Quiz</div>
            <div class="screenshot-badge-url">cc.bruniaux.com</div>
          </div>
        </div>

        <h2>Quiz Complete!</h2>
        <div class="score-display" id="score-display">85%</div>
        <div class="score-label" id="score-label">42 / 50 correct answers</div>
        <div class="score-delta" id="score-delta"></div>
        <div class="score-badge" id="score-badge">Expert</div>

        <div class="results-meta">
          <div class="meta-item">
            <div class="meta-value" id="meta-questions">50</div>
            <div class="meta-label">Questions</div>
          </div>
          <div class="meta-item">
            <div class="meta-value" id="meta-correct">42</div>
            <div class="meta-label">Correct</div>
          </div>
          <div class="meta-item">
            <div class="meta-value" id="meta-time">12:34</div>
            <div class="meta-label">Time</div>
          </div>
        </div>

        <h4 style="margin-bottom: var(--space-md); text-align: left;">Score by Category</h4>
        <div class="category-scores" id="category-scores">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="history-section" id="history-section">
        <h4>Your History <span style="font-size: 0.75rem; font-weight: normal; color: var(--text-muted); font-style: italic;">· idea by <a href="https://www.linkedin.com/in/jeff-ladiray-79203657/" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">Jeff Ladiray</a></span></h4>
        <div class="history-list" id="history-list">
          <!-- Populated by JS -->
        </div>
        <a class="clear-history" id="clear-history">Clear History</a>
      </div>

      <div class="most-missed-section" id="most-missed-section" style="display: none;">
        <h4>Most Missed Questions</h4>
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-md);">
          These questions have the lowest success rates overall.
        </p>
        <div id="most-missed-list"></div>
      </div>

      <div class="share-text" id="share-text">
        Claude Code Quiz: 85% (42/50) - Expert level!
        Test yours: cc.bruniaux.com/quiz
      </div>

      <div class="results-actions">
        <button class="btn btn-secondary" id="copy-result-btn">Copy Result</button>
        <button class="btn btn-primary" id="retry-btn">Try Again</button>
      </div>
    </div>
  </div>

  <style>
    /* Quiz-specific styles */
    .quiz-container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-lg);
      min-height: calc(100vh - 200px);
    }

    .quiz-setup {
      text-align: center;
      padding: var(--space-2xl) 0;
    }

    .quiz-setup h1 {
      margin-bottom: var(--space-md);
    }

    .quiz-setup p {
      color: var(--text-secondary);
      margin-bottom: var(--space-2xl);
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-2xl);
      text-align: left;
    }

    .category-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .category-item:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .category-item.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }

    .category-item input {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
    }

    .category-item label {
      flex: 1;
      cursor: pointer;
    }

    .category-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .difficulty-select {
      display: flex;
      gap: var(--space-md);
      justify-content: center;
      margin-bottom: var(--space-2xl);
      flex-wrap: wrap;
    }

    .difficulty-btn {
      padding: var(--space-md) var(--space-xl);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .difficulty-btn:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .difficulty-btn.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }

    .start-btn {
      padding: var(--space-md) var(--space-2xl);
      font-size: 1.1rem;
    }

    .selected-count {
      margin-bottom: var(--space-lg);
      color: var(--text-secondary);
    }

    .previous-best {
      margin-bottom: var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .previous-best.has-data {
      color: var(--accent);
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .category-header h3 {
      margin: 0;
    }

    .category-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .category-action-btn {
      padding: var(--space-xs) var(--space-md);
      font-size: 0.85rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .category-action-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }

    .quiz-question {
      display: none;
    }

    .quiz-question.active {
      display: block;
    }

    .progress-bar {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      margin-bottom: var(--space-xl);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, #a855f7 100%);
      transition: width 0.3s ease;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .question-number {
      font-family: var(--font-mono);
      color: var(--text-secondary);
    }

    .question-category {
      font-size: 0.85rem;
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-tertiary);
      border-radius: 4px;
      color: var(--text-secondary);
    }

    .question-difficulty {
      font-size: 0.8rem;
      padding: var(--space-xs) var(--space-sm);
      border-radius: 4px;
    }

    .difficulty-junior { background: #22c55e20; color: #22c55e; }
    .difficulty-senior { background: #f59e0b20; color: #f59e0b; }
    .difficulty-power { background: #ef444420; color: #ef4444; }

    .question-text {
      font-size: 1.25rem;
      margin-bottom: var(--space-xl);
      line-height: 1.5;
    }

    .question-text code {
      font-family: var(--font-mono);
      font-size: 0.9em;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: #e6db74;
    }

    .question-text pre {
      margin: var(--space-sm) 0;
      padding: var(--space-sm);
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      overflow-x: auto;
    }

    .question-text pre code {
      background: none;
      border: none;
      padding: 0;
      display: block;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    .option-btn {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: var(--border-radius);
      text-align: left;
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .option-btn:hover:not(.disabled) {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
    }

    .option-btn.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }

    .option-btn.correct {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .option-btn.incorrect {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .option-btn.disabled {
      cursor: default;
    }

    .option-btn code {
      font-family: var(--font-mono);
      font-size: 0.9em;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: #e6db74;
    }

    .option-btn pre {
      margin: var(--space-xs) 0;
      padding: var(--space-xs);
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      overflow-x: auto;
    }

    .option-btn pre code {
      background: none;
      border: none;
      padding: 0;
      display: block;
    }

    .option-key {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .explanation-box {
      display: none;
      padding: var(--space-lg);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      margin-bottom: var(--space-xl);
      border-left: 4px solid var(--accent);
    }

    .explanation-box.show {
      display: block;
    }

    .explanation-box h4 {
      margin-bottom: var(--space-sm);
      color: var(--text-primary);
    }

    .explanation-box p {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .explanation-box code {
      font-family: var(--font-mono);
      font-size: 0.9em;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: #e6db74;
    }

    .explanation-box pre {
      margin: var(--space-sm) 0;
      padding: var(--space-sm);
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      overflow-x: auto;
    }

    .explanation-box pre code {
      background: none;
      border: none;
      padding: 0;
      display: block;
    }

    .success-rate {
      margin-top: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .explanation-box .doc-links {
      margin-top: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .explanation-box .doc-link {
      display: inline-block;
      font-size: 0.9rem;
    }

    .explanation-box .official-doc-link {
      opacity: 0.7;
      font-size: 0.85rem;
    }

    .report-error-section {
      margin-top: var(--space-lg);
      padding-top: var(--space-md);
      border-top: 1px solid var(--border);
    }

    .btn-report-error {
      display: inline-block;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--border-radius);
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-report-error:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .question-actions {
      display: flex;
      justify-content: space-between;
      gap: var(--space-md);
    }

    .nav-btn {
      padding: var(--space-sm) var(--space-lg);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quiz-results {
      display: none;
      text-align: center;
      padding: var(--space-2xl) 0;
    }

    .quiz-results.active {
      display: block;
    }

    .results-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: var(--border-radius-lg);
      padding: var(--space-2xl);
      margin-bottom: var(--space-2xl);
      transition: all var(--transition-normal);
    }

    .results-card:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px rgba(88, 166, 255, 0.15);
    }

    .results-card h2 {
      margin-bottom: var(--space-lg);
    }

    .score-display {
      font-size: 4rem;
      font-weight: 700;
      margin-bottom: var(--space-md);
      background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-label {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: var(--space-xl);
    }

    .score-delta {
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--border-radius);
    }

    .score-delta.positive { color: #22c55e; background: rgba(34, 197, 94, 0.1); }
    .score-delta.negative { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
    .score-delta.neutral { color: var(--text-muted); background: var(--bg-tertiary); }
    .score-delta.first { color: var(--accent); background: rgba(88, 166, 255, 0.1); }

    .category-delta {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 700;
      margin-left: var(--space-xs);
      padding: 2px 6px;
      border-radius: 3px;
    }

    .category-delta.positive { color: #22c55e; background: rgba(34, 197, 94, 0.15); }
    .category-delta.negative { color: #ef4444; background: rgba(239, 68, 68, 0.15); }

    .score-badge {
      display: inline-block;
      padding: var(--space-sm) var(--space-lg);
      border-radius: 20px;
      font-weight: 600;
      margin-bottom: var(--space-xl);
    }

    .badge-novice { background: #64748b20; color: #64748b; }
    .badge-apprentice { background: #22c55e20; color: #22c55e; }
    .badge-practitioner { background: #3b82f620; color: #3b82f6; }
    .badge-expert { background: #a855f720; color: #a855f7; }
    .badge-master { background: #f59e0b20; color: #f59e0b; }

    .category-scores { text-align: left; margin-bottom: var(--space-xl); }

    .category-score-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border);
    }

    .category-score-item:last-child { border-bottom: none; }

    .category-score-bar {
      width: 100px;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .category-score-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
    }

    .results-meta {
      display: flex;
      justify-content: center;
      gap: var(--space-xl);
      flex-wrap: wrap;
      margin-bottom: var(--space-xl);
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
    }

    .meta-item { text-align: center; }
    .meta-value { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); }
    .meta-label { font-size: 0.8rem; color: var(--text-muted); }

    .most-missed-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      padding: var(--space-lg);
      margin-bottom: var(--space-2xl);
      text-align: left;
    }

    .most-missed-section h4 { margin-bottom: var(--space-sm); color: var(--text-primary); }

    #most-missed-list { max-height: 300px; overflow-y: auto; }

    .missed-question-item {
      padding: var(--space-sm);
      margin-bottom: var(--space-sm);
      background: var(--bg-tertiary);
      border-left: 3px solid var(--warning);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .missed-question-item .question-info { flex: 1; }
    .missed-question-item .question-id { font-weight: 600; color: var(--text-primary); font-family: var(--font-mono); }
    .missed-question-item .question-preview { color: var(--text-secondary); margin-top: var(--space-xs); }
    .missed-question-item .success-rate { font-family: var(--font-mono); font-weight: 600; color: var(--warning); font-size: 1.1rem; margin-left: var(--space-md); }

    .results-actions { display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap; }

    .share-text {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      text-align: left;
      margin-bottom: var(--space-lg);
      word-break: break-word;
    }

    .screenshot-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border: 2px solid var(--accent);
      border-radius: var(--border-radius-lg);
      margin-bottom: var(--space-lg);
    }

    .screenshot-badge img { width: 40px; height: 40px; }
    .screenshot-badge-text { text-align: left; }
    .screenshot-badge-title { font-weight: 600; color: var(--text-primary); }
    .screenshot-badge-url { font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); }

    .history-section {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: var(--border-radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-2xl);
      transition: all var(--transition-normal);
    }

    .history-section:hover { border-color: var(--accent); box-shadow: 0 8px 32px rgba(88, 166, 255, 0.15); }
    .history-section h4 { margin-bottom: var(--space-md); text-align: left; }
    .history-list { display: flex; flex-direction: column; gap: var(--space-sm); }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      border-left: 3px solid transparent;
      transition: all var(--transition-fast);
    }

    .history-item:hover { background: var(--bg-secondary); }
    .history-item.best { border-left-color: var(--accent); background: rgba(88, 166, 255, 0.05); }
    .history-date { color: var(--text-muted); font-size: 0.85rem; }
    .history-score { font-family: var(--font-mono); font-weight: 600; color: var(--text-primary); }
    .history-badge { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; }
    .history-meta { color: var(--text-muted); font-size: 0.8rem; }

    .clear-history {
      display: inline-block;
      margin-top: var(--space-md);
      color: var(--text-muted);
      font-size: 0.85rem;
      text-decoration: underline;
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .clear-history:hover { color: var(--accent); }
    .empty-history { text-align: center; color: var(--text-muted); padding: var(--space-lg); font-style: italic; }

    @media (max-width: 480px) {
      .quiz-container { padding: var(--space-md); }
      .question-text { font-size: 1.1rem; }
      .score-display { font-size: 3rem; }
      .question-actions { flex-direction: column; }
      .nav-btn { width: 100%; }
      .score-delta { font-size: 0.9rem; }
      .history-item { flex-direction: column; align-items: flex-start; gap: var(--space-xs); }
      .history-meta { font-size: 0.75rem; }
      .category-delta { font-size: 0.7rem; }
      .category-header { flex-direction: column; align-items: flex-start; }
      .category-actions { width: 100%; }
      .category-action-btn { flex: 1; }
    }
  </style>

  <script is:inline>
    // Quiz State
    let quizData = null;
    let selectedCategories = new Set();
    let selectedDifficulty = 'all';
    let filteredQuestions = [];
    let currentQuestionIndex = 0;
    let answers = {};
    let startTime = null;

    function getCategoryName(categoryId) {
      const category = quizData.categories.find(c => c.id === categoryId);
      return category ? category.name : 'Unknown';
    }

    function getQuizHistory() {
      try {
        const stored = localStorage.getItem('ccquiz_history');
        return stored ? JSON.parse(stored) : [];
      } catch (e) { return []; }
    }

    function saveQuizAttempt(attempt) {
      try {
        let history = getQuizHistory();
        history.push(attempt);
        if (history.length > 20) history = history.slice(-20);
        localStorage.setItem('ccquiz_history', JSON.stringify(history));
      } catch (e) {}
    }

    function getConfigKey(difficulty, categoryIds) {
      const sortedIds = [...categoryIds].sort((a, b) => a - b);
      return `${difficulty}_${sortedIds.join(',')}`;
    }

    function getBestForConfig(configKey) {
      const history = getQuizHistory();
      const matching = history.filter(a => getConfigKey(a.difficulty, a.categoryIds) === configKey);
      if (matching.length === 0) return null;
      return matching.reduce((best, current) => current.score > best.score ? current : best);
    }

    function getPreviousForConfig(configKey) {
      const history = getQuizHistory();
      const matching = history.filter(a => getConfigKey(a.difficulty, a.categoryIds) === configKey);
      if (matching.length === 0) return null;
      return matching[matching.length - 1];
    }

    function getQuestionStats() {
      try {
        const stored = localStorage.getItem('ccquiz_question_stats');
        return stored ? JSON.parse(stored) : {};
      } catch (e) { return {}; }
    }

    function saveQuestionStats(stats) {
      try { localStorage.setItem('ccquiz_question_stats', JSON.stringify(stats)); } catch (e) {}
    }

    function updateQuestionStats(questionId, isCorrect) {
      const stats = getQuestionStats();
      if (!stats[questionId]) stats[questionId] = { attempts: 0, correct: 0 };
      stats[questionId].attempts++;
      if (isCorrect) stats[questionId].correct++;
      saveQuestionStats(stats);
      return stats[questionId];
    }

    function getSuccessRate(questionId) {
      const stats = getQuestionStats();
      const qStats = stats[questionId];
      if (!qStats || qStats.attempts < 3) return null;
      return Math.round((qStats.correct / qStats.attempts) * 100);
    }

    const setupScreen = document.getElementById('quiz-setup');
    const questionScreen = document.getElementById('quiz-question');
    const resultsScreen = document.getElementById('quiz-results');
    const categoryGrid = document.getElementById('category-grid');
    const selectedCountEl = document.getElementById('selected-count');
    const startBtn = document.getElementById('start-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    async function loadQuestions() {
      const response = await fetch('/api/questions.json');
      quizData = await response.json();
      renderCategoryGrid();
    }

    function renderCategoryGrid() {
      const categoryCounts = {};
      quizData.questions.forEach(q => { categoryCounts[q.category_id] = (categoryCounts[q.category_id] || 0) + 1; });

      categoryGrid.innerHTML = quizData.categories.map(cat => `
        <div class="category-item" data-id="${cat.id}">
          <input type="checkbox" id="cat-${cat.id}" checked>
          <label for="cat-${cat.id}">${cat.name}</label>
          <span class="category-count">${categoryCounts[cat.id] || 0}</span>
        </div>
      `).join('');

      quizData.categories.forEach(cat => selectedCategories.add(cat.id));
      updateSelectedCount();

      categoryGrid.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
          const checkbox = item.querySelector('input');
          checkbox.checked = !checkbox.checked;
          toggleCategory(parseInt(item.dataset.id), checkbox.checked);
        });
        item.querySelector('input').addEventListener('change', (e) => {
          toggleCategory(parseInt(item.dataset.id), e.target.checked);
        });
      });

      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedDifficulty = btn.dataset.difficulty;
          updateSelectedCount();
        });
      });

      document.getElementById('select-all-btn').addEventListener('click', () => {
        quizData.categories.forEach(cat => {
          const checkbox = document.getElementById(`cat-${cat.id}`);
          if (!checkbox.checked) { checkbox.checked = true; toggleCategory(cat.id, true); }
        });
      });

      document.getElementById('deselect-all-btn').addEventListener('click', () => {
        quizData.categories.forEach(cat => {
          const checkbox = document.getElementById(`cat-${cat.id}`);
          if (checkbox.checked) { checkbox.checked = false; toggleCategory(cat.id, false); }
        });
      });
    }

    function toggleCategory(id, checked) {
      const item = categoryGrid.querySelector(`[data-id="${id}"]`);
      if (checked) { selectedCategories.add(id); item.classList.add('selected'); }
      else { selectedCategories.delete(id); item.classList.remove('selected'); }
      updateSelectedCount();
    }

    function updateSelectedCount() {
      filteredQuestions = quizData.questions.filter(q => {
        const categoryMatch = selectedCategories.has(q.category_id);
        const difficultyMatch = selectedDifficulty === 'all' || q.difficulty === selectedDifficulty;
        return categoryMatch && difficultyMatch;
      });
      selectedCountEl.textContent = `${filteredQuestions.length} questions selected`;
      startBtn.disabled = filteredQuestions.length === 0;
      updatePreviousBest();
    }

    function updatePreviousBest() {
      const previousBestEl = document.getElementById('previous-best');
      if (selectedCategories.size === 0) { previousBestEl.textContent = ''; previousBestEl.className = 'previous-best'; return; }
      const currentCategoryIds = Array.from(selectedCategories);
      const configKey = getConfigKey(selectedDifficulty, currentCategoryIds);
      const best = getBestForConfig(configKey);
      if (best) { previousBestEl.textContent = `Previous best: ${best.score}% (${best.badge})`; previousBestEl.className = 'previous-best has-data'; }
      else { previousBestEl.textContent = 'No previous attempt with this setup'; previousBestEl.className = 'previous-best'; }
    }

    startBtn.addEventListener('click', () => {
      if (filteredQuestions.length === 0) return;
      filteredQuestions = filteredQuestions.sort(() => Math.random() - 0.5);
      currentQuestionIndex = 0;
      answers = {};
      startTime = Date.now();
      setupScreen.style.display = 'none';
      questionScreen.classList.add('active');
      renderQuestion();
    });

    function formatExplanation(text) {
      if (!text) return '';
      const escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
      text = text.replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${escapeHtml(code.trim())}</code></pre>`);
      text = text.replace(/`([^`]+)`/g, (match, code) => `<code>${escapeHtml(code)}</code>`);
      return text;
    }

    function renderQuestion() {
      const q = filteredQuestions[currentQuestionIndex];
      const total = filteredQuestions.length;
      document.getElementById('progress-fill').style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
      document.getElementById('question-number').innerHTML = `${currentQuestionIndex + 1} / ${total}  ·  <a href="https://github.com/FlorianBruniaux/claude-code-ultimate-guide-landing/blob/main/${q.source_file}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline; text-decoration-style: dotted;">${q.id}</a>`;
      document.getElementById('question-category').textContent = getCategoryName(q.category_id);
      const diffEl = document.getElementById('question-difficulty');
      diffEl.textContent = q.difficulty;
      diffEl.className = `question-difficulty difficulty-${q.difficulty}`;
      document.getElementById('question-text').innerHTML = formatExplanation(q.question);

      const optionsList = document.getElementById('options-list');
      const keys = ['a', 'b', 'c', 'd'];
      optionsList.innerHTML = keys.map(key => {
        if (!q.options[key]) return '';
        const isAnswered = answers[q.id] !== undefined;
        const isSelected = answers[q.id] === key;
        const isCorrect = key === q.correct;
        let classes = 'option-btn';
        if (isAnswered) { classes += ' disabled'; if (isCorrect) classes += ' correct'; else if (isSelected) classes += ' incorrect'; }
        else if (isSelected) classes += ' selected';
        return `<button class="${classes}" data-key="${key}" ${isAnswered ? 'disabled' : ''}><span class="option-key">${key.toUpperCase()}</span><span>${formatExplanation(q.options[key])}</span></button>`;
      }).join('');

      if (!answers[q.id]) {
        optionsList.querySelectorAll('.option-btn').forEach(btn => { btn.addEventListener('click', () => selectAnswer(btn.dataset.key)); });
      }

      const explanationBox = document.getElementById('explanation-box');
      if (answers[q.id]) {
        explanationBox.classList.add('show');
        document.getElementById('explanation-text').innerHTML = formatExplanation(q.explanation);
        const successRateEl = document.getElementById('success-rate');
        const successRate = getSuccessRate(q.id);
        if (successRate !== null) { successRateEl.textContent = `Your accuracy: ${successRate}%`; successRateEl.style.display = 'block'; }
        else { successRateEl.style.display = 'none'; }
        const docLink = document.getElementById('doc-link');
        if (q.doc_reference) { docLink.href = `https://github.com/FlorianBruniaux/claude-code-ultimate-guide/blob/main/${q.doc_reference.file}${q.doc_reference.anchor || ''}`; docLink.style.display = 'inline-block'; }
        else { docLink.style.display = 'none'; }
        const officialDocLink = document.getElementById('official-doc-link');
        if (q.official_doc) { officialDocLink.href = q.official_doc; officialDocLink.style.display = 'inline-block'; }
        else { officialDocLink.style.display = 'none'; }
        const btnReportError = document.getElementById('btn-report-error');
        const issueTitle = `Question ${q.id}: Error report`;
        const issueBody = `**Question ID:** ${q.id}\n**Category:** ${getCategoryName(q.category_id)}\n**Difficulty:** ${q.difficulty}\n\n**Question text:**\n${q.question}\n\n**Source file:** [View on GitHub](https://github.com/FlorianBruniaux/claude-code-ultimate-guide-landing/blob/main/${q.source_file})\n\n---\n\n**Describe the issue:**\n<!-- Examples: ambiguous wording, outdated information, wrong answer, typo, etc. -->\n\n`;
        btnReportError.href = `https://github.com/FlorianBruniaux/claude-code-ultimate-guide-landing/issues/new?title=${encodeURIComponent(issueTitle)}&body=${encodeURIComponent(issueBody)}&labels=quiz,question-error`;
      } else { explanationBox.classList.remove('show'); }

      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.textContent = currentQuestionIndex === total - 1 ? 'Finish' : 'Next';
    }

    function selectAnswer(key) {
      const q = filteredQuestions[currentQuestionIndex];
      answers[q.id] = key;
      updateQuestionStats(q.id, key === q.correct);
      renderQuestion();
    }

    prevBtn.addEventListener('click', () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); } });

    nextBtn.addEventListener('click', () => {
      const q = filteredQuestions[currentQuestionIndex];
      if (!answers[q.id]) { alert('Please select an answer before continuing.'); return; }
      if (currentQuestionIndex < filteredQuestions.length - 1) { currentQuestionIndex++; renderQuestion(); }
      else { showResults(); }
    });

    function showResults() {
      questionScreen.classList.remove('active');
      resultsScreen.classList.add('active');
      const total = filteredQuestions.length;
      let correct = 0;
      const categoryScores = {};
      filteredQuestions.forEach(q => {
        const catName = getCategoryName(q.category_id);
        if (!categoryScores[catName]) categoryScores[catName] = { correct: 0, total: 0 };
        categoryScores[catName].total++;
        if (answers[q.id] === q.correct) { correct++; categoryScores[catName].correct++; }
      });
      const percentage = Math.round((correct / total) * 100);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      let badge, badgeClass;
      if (percentage >= 95) { badge = 'Master'; badgeClass = 'badge-master'; }
      else if (percentage >= 80) { badge = 'Expert'; badgeClass = 'badge-expert'; }
      else if (percentage >= 65) { badge = 'Practitioner'; badgeClass = 'badge-practitioner'; }
      else if (percentage >= 50) { badge = 'Apprentice'; badgeClass = 'badge-apprentice'; }
      else { badge = 'Novice'; badgeClass = 'badge-novice'; }
      const currentCategoryIds = Array.from(selectedCategories);
      const configKey = getConfigKey(selectedDifficulty, currentCategoryIds);
      const previousBest = getBestForConfig(configKey);
      const previousAttempt = getPreviousForConfig(configKey);
      let scoreDelta = null;
      let scoreDeltaType = 'first';
      if (previousBest) { scoreDelta = percentage - previousBest.score; if (scoreDelta > 0) scoreDeltaType = 'positive'; else if (scoreDelta < 0) scoreDeltaType = 'negative'; else scoreDeltaType = 'neutral'; }
      const categoryDeltas = {};
      if (previousAttempt && previousAttempt.categoryScores) {
        Object.keys(categoryScores).forEach(catName => {
          const current = categoryScores[catName]; const prev = previousAttempt.categoryScores[catName];
          if (prev) { const delta = current.correct - prev.correct; if (delta !== 0) categoryDeltas[catName] = delta; }
        });
      }
      saveQuizAttempt({ date: new Date().toISOString(), score: percentage, correct, total, badge, timeElapsed: elapsed, difficulty: selectedDifficulty, categoryIds: currentCategoryIds, categoryScores });
      document.getElementById('score-display').textContent = `${percentage}%`;
      document.getElementById('score-label').textContent = `${correct} / ${total} correct answers`;
      const scoreDeltaEl = document.getElementById('score-delta');
      if (scoreDeltaType === 'first') { scoreDeltaEl.textContent = 'First attempt with this setup'; scoreDeltaEl.className = 'score-delta first'; }
      else if (scoreDeltaType === 'positive') { if (scoreDelta === percentage) { scoreDeltaEl.textContent = 'New personal best!'; scoreDeltaEl.className = 'score-delta first'; } else { scoreDeltaEl.textContent = `+${scoreDelta} pts vs previous best`; scoreDeltaEl.className = 'score-delta positive'; } }
      else if (scoreDeltaType === 'negative') { scoreDeltaEl.textContent = `${scoreDelta} pts vs previous best`; scoreDeltaEl.className = 'score-delta negative'; }
      else { scoreDeltaEl.textContent = 'Same as your best'; scoreDeltaEl.className = 'score-delta neutral'; }
      const badgeEl = document.getElementById('score-badge');
      badgeEl.textContent = badge; badgeEl.className = `score-badge ${badgeClass}`;
      document.getElementById('meta-questions').textContent = total;
      document.getElementById('meta-correct').textContent = correct;
      document.getElementById('meta-time').textContent = timeStr;
      const categoryScoresEl = document.getElementById('category-scores');
      categoryScoresEl.innerHTML = Object.entries(categoryScores).map(([cat, score]) => {
        const catPct = Math.round((score.correct / score.total) * 100);
        const delta = categoryDeltas[cat]; let deltaHTML = '';
        if (delta !== undefined) { const deltaClass = delta > 0 ? 'positive' : 'negative'; const deltaSign = delta > 0 ? '+' : ''; deltaHTML = `<span class="category-delta ${deltaClass}">${deltaSign}${delta}</span>`; }
        return `<div class="category-score-item"><span>${cat}</span><div style="display: flex; align-items: center; gap: var(--space-sm);"><span style="font-family: var(--font-mono); font-size: 0.9rem;">${score.correct}/${score.total}${deltaHTML}</span><div class="category-score-bar"><div class="category-score-fill" style="width: ${catPct}%"></div></div></div></div>`;
      }).join('');
      document.getElementById('share-text').textContent = `Claude Code Quiz: ${percentage}% (${correct}/${total}) - ${badge} level!\nTest yours: cc.bruniaux.com/quiz`;
      renderMostMissedQuestions();
      renderHistory();
    }

    function renderMostMissedQuestions() {
      const mostMissedSection = document.getElementById('most-missed-section');
      const stats = getQuestionStats();
      const questionsWithStats = Object.entries(stats).filter(([qid, data]) => data.attempts >= 3).map(([qid, data]) => ({ qid, rate: Math.round((data.correct / data.attempts) * 100), attempts: data.attempts })).sort((a, b) => a.rate - b.rate).slice(0, 5);
      if (questionsWithStats.length === 0) { mostMissedSection.style.display = 'none'; return; }
      mostMissedSection.style.display = 'block';
      document.getElementById('most-missed-list').innerHTML = questionsWithStats.map(item => {
        const q = quizData.questions.find(q => q.id === item.qid); if (!q) return '';
        const questionPreview = q.question.length > 80 ? q.question.substring(0, 80) + '...' : q.question;
        return `<div class="missed-question-item"><div class="question-info"><div class="question-id">${item.qid}</div><div class="question-preview">${questionPreview}</div></div><div class="success-rate">${item.rate}%</div></div>`;
      }).join('');
    }

    function renderHistory() {
      const historyList = document.getElementById('history-list');
      const history = getQuizHistory();
      if (history.length === 0) { historyList.innerHTML = '<div class="empty-history">No previous attempts yet</div>'; return; }
      const recent = history.slice(-5).reverse();
      const bestScore = Math.max(...history.map(a => a.score));
      historyList.innerHTML = recent.map(attempt => {
        const date = new Date(attempt.date); const now = new Date(); const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000); const diffHours = Math.floor(diffMs / 3600000); const diffDays = Math.floor(diffMs / 86400000);
        let relativeTime; if (diffMins < 1) relativeTime = 'Just now'; else if (diffMins < 60) relativeTime = `${diffMins}m ago`; else if (diffHours < 24) relativeTime = `${diffHours}h ago`; else if (diffDays < 7) relativeTime = `${diffDays}d ago`; else relativeTime = date.toLocaleDateString();
        const minutes = Math.floor(attempt.timeElapsed / 60); const seconds = attempt.timeElapsed % 60; const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const categoryCount = attempt.categoryIds ? attempt.categoryIds.length : 0;
        const isBest = attempt.score === bestScore; const itemClass = isBest ? 'history-item best' : 'history-item';
        const badgeClassMap = { 'Master': 'badge-master', 'Expert': 'badge-expert', 'Practitioner': 'badge-practitioner', 'Apprentice': 'badge-apprentice', 'Novice': 'badge-novice' };
        const badgeClass = badgeClassMap[attempt.badge] || '';
        return `<div class="${itemClass}"><div style="display: flex; align-items: center; gap: var(--space-md);"><span class="history-date">${relativeTime}</span><span class="history-score">${attempt.score}%</span><span class="history-badge score-badge ${badgeClass}">${attempt.badge}</span></div><div class="history-meta">${timeStr} · ${categoryCount} categories</div></div>`;
      }).join('');
    }

    document.getElementById('copy-result-btn').addEventListener('click', () => {
      const text = document.getElementById('share-text').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copy-result-btn');
        btn.textContent = 'Copied!'; btn.style.backgroundColor = 'var(--accent-secondary)'; btn.style.borderColor = 'var(--accent-secondary)'; btn.style.color = '#fff';
        setTimeout(() => { btn.textContent = 'Copy Result'; btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; }, 2000);
      });
    });

    document.getElementById('retry-btn').addEventListener('click', () => { resultsScreen.classList.remove('active'); setupScreen.style.display = 'block'; currentQuestionIndex = 0; answers = {}; });

    document.getElementById('clear-history').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear your quiz history? This cannot be undone.')) { localStorage.removeItem('ccquiz_history'); renderHistory(); }
    });

    document.addEventListener('keydown', (e) => {
      if (!questionScreen.classList.contains('active')) return;
      const q = filteredQuestions[currentQuestionIndex];
      if (!answers[q.id]) { if (['a', 'b', 'c', 'd'].includes(e.key.toLowerCase())) selectAnswer(e.key.toLowerCase()); }
      if (e.key === 'Enter' || e.key === 'ArrowRight') nextBtn.click();
      else if (e.key === 'ArrowLeft') prevBtn.click();
    });

    loadQuestions();
  </script>
</Layout>
